<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPPDP Lite - Clinical Simulator</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 650px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #004a99; text-align: center; margin-top: 0; }
        .hidden { display: none; }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #004a99; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #003366; }
        .btn-secondary { background: #6c757d; }
        .vitals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; margin: 15px 0; border: 2px solid #333; }
        .ecg-box { width: 100%; margin: 15px 0; border: 3px solid #333; border-radius: 4px; display: block; }
        .q-box { margin-top: 20px; padding: 15px; border-left: 5px solid #004a99; background: #f8f9fa; border-radius: 0 8px 8px 0; }
        .scene-text { line-height: 1.6; font-size: 1.1em; background: #e9ecef; padding: 15px; border-radius: 8px; font-weight: 500; }
        textarea { width: 100%; height: 100px; margin-top: 10px; border-radius: 8px; border: 1px solid #ced4da; padding: 10px; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        .status-bar { text-align: center; font-size: 0.9em; color: #666; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .summary-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .summary-q { font-weight: bold; color: #004a99; display: block; margin-bottom: 5px; }
        #debug-log { font-size: 10px; color: #ccc; margin-top: 40px; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>

<div class="container" id="app">
    <h1 id="main-title">SPPDP Lite</h1>
    
    <div id="selection-screen">
        <div class="status-bar">Select training phase</div>
        <button class="btn" onclick="loadBatch(1)">Phase 1: Resuscitation (Wk 1-2)</button>
        <button class="btn" onclick="loadBatch(2)">Phase 2: Medical (Wk 6-12)</button>
        <button class="btn" onclick="loadBatch(3)">Phase 3: Trauma/Neuro (Wk 13-23)</button>
        <button class="btn" onclick="loadBatch(4)">Phase 4: Toxicology (Wk 37-45)</button>
    </div>

    <div id="sim-screen" class="hidden">
        <div class="status-bar" id="phase-indicator">Clinical Simulation</div>
        <div id="scene-description" class="scene-text"></div>
        
        <div class="vitals-grid">
            <div>HR: <span id="v-hr">--</span></div>
            <div>BP: <span id="v-bp">--/--</span></div>
            <div>SpO2: <span id="v-spo2">--%</span></div>
            <div>GCS: <span id="v-gcs">--</span></div>
        </div>

        <img id="ecg-display" class="ecg-box hidden" src="" alt="ECG Strip">

        <div id="question-area" class="q-box">
            <strong id="current-question-num">Question 1 of 8</strong>
            <p id="current-question-text" style="margin-top: 5px; min-height: 3em;"></p>
            <textarea id="answer-input" placeholder="Enter clinical rationale..."></textarea>
            <button class="btn" onclick="nextQuestion()">Submit Response</button>
            <button class="btn btn-secondary" onclick="location.reload()" style="padding: 8px; font-size: 12px;">Reset Scenario</button>
        </div>
    </div>

    <div id="summary-screen" class="hidden">
        <h2 style="color: #004a99; text-align: center;">Scenario Summary</h2>
        <div id="summary-content" style="margin-bottom: 20px;"></div>
        <button class="btn" onclick="location.reload()">Start New Scenario</button>
    </div>

    <div id="debug-log"></div>
</div>

<script>
    let currentBatchData = null;
    let currentScenario = null;
    let questionStep = 0;
    let userAnswers = [];

    const questions = [
        "Identify scene hazards and how you would address them.",
        "Any clarifying questions or further assessments needed?",
        "What is your provisional diagnosis?",
        "Justify your provisional diagnosis using clinical findings.",
        "What differential diagnoses have you considered and discarded?",
        "What is your treatment/intervention plan (per DTP/CPG)?",
        "What is your extrication plan?",
        "What is your disposition plan (Transport/Consult/ROSC)??"
    ];

    function log(msg) { document.getElementById('debug-log').innerText += msg + "\n"; }

    async function loadBatch(batchNum) {
        try {
            const response = await fetch(`./logic/logic_map_batch${batchNum}.json`);
            if (!response.ok) throw new Error("Fetch failed");
            currentBatchData = await response.json();
            startRandomScenario();
        } catch (e) {
            alert("Error: Check folder/file names on GitHub.");
        }
    }

    function startRandomScenario() {
        const keys = Object.keys(currentBatchData);
        const randomKey = keys[Math.floor(Math.random() * keys.length)];
        const weekData = currentBatchData[randomKey];
        
        if (weekData.branches && weekData.logic_map) {
            const randomBranch = weekData.branches[Math.floor(Math.random() * weekData.branches.length)];
            currentScenario = weekData.logic_map[randomBranch];
        } else {
            currentScenario = weekData;
        }
        displayScenario();
    }

    function displayScenario() {
        document.getElementById('selection-screen').classList.add('hidden');
        document.getElementById('sim-screen').classList.remove('hidden');
        
        // Deep search for properties
        const findInObj = (obj, key) => {
            if (obj[key]) return obj[key];
            for (let prop in obj) {
                if (typeof obj[prop] === 'object' && obj[prop] !== null) {
                    let result = findInObj(obj[prop], key);
                    if (result) return result;
                }
            }
            return null;
        };

        const sceneText = findInObj(currentScenario, 'scenario') || findInObj(currentScenario, 'description') || "No description found.";
        document.getElementById('scene-description').innerText = sceneText;
        
        // Vitals mapping with deep search and defaults
        const vitals = findInObj(currentScenario, 'vitals_baseline') || findInObj(currentScenario, 'vitals') || {};
        
        document.getElementById('v-hr').innerText = vitals.hr || "Normal";
        document.getElementById('v-bp').innerText = vitals.bp_systolic ? `${vitals.bp_systolic}/--` : (vitals.bp || "Normal");
        document.getElementById('v-spo2').innerText = vitals.spO2 || vitals.spo2 || "98%";
        document.getElementById('v-gcs').innerText = vitals.gcs || "15";

        // ECG Search
        let ecgFile = findInObj(currentScenario, 'ecg_image');
        if (Array.isArray(ecgFile)) ecgFile = ecgFile[0];

        const imgElement = document.getElementById('ecg-display');
        if (ecgFile && ecgFile !== "nil" && ecgFile !== "none") {
            imgElement.src = `./images/${ecgFile}`;
            imgElement.classList.remove('hidden');
        } else {
            imgElement.classList.add('hidden');
        }

        questionStep = 0; userAnswers = []; updateQuestion();
    }

    function updateQuestion() {
        document.getElementById('current-question-num').innerText = `Question ${questionStep + 1} of 8`;
        document.getElementById('current-question-text').innerText = questions[questionStep];
        document.getElementById('answer-input').value = "";
    }

    function nextQuestion() {
        const val = document.getElementById('answer-input').value.trim();
        if (val === "") { alert("Please provide a response."); return; }
        userAnswers.push({ q: questions[questionStep], a: val });
        questionStep++;
        if (questionStep < questions.length) { updateQuestion(); } else { showSummary(); }
    }

    function showSummary() {
        document.getElementById('sim-screen').classList.add('hidden');
        document.getElementById('summary-screen').classList.remove('hidden');
        document.getElementById('main-title').innerText = "Report Card";
        let html = `<div class="scene-text" style="margin-bottom:20px"><strong>Scenario:</strong> ${document.getElementById('scene-description').innerText}</div>`;
        userAnswers.forEach((item, index) => {
            html += `<div class="summary-item"><span class="summary-q">Q${index+1}: ${item.q}</span><div>${item.a}</div></div>`;
        });
        document.getElementById('summary-content').innerHTML = html;
    }
</script>
</body>
</html>
